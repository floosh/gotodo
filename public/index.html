<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="utf-8" />
    <title>GoTodo</title>
    <link rel='stylesheet' href='/css/style.css' />
    <link rel='stylesheet' href='/css/pure-min.css' />
    <link rel="stylesheet" href="/css/all.css"/>
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.5.0/css/all.css">
    <script type="text/javascript" src="/lib/jquery-3.3.1.js"></script>
    <script type="text/javascript" src="/lib/handlebars.min.js"></script>
</head>

<body>
    <div class="header">
        <h1><i class="far fa-list-alt"></i> GoToDo</h1>
    </div>
    <div class="content">
        <form id="todoForm" class="pure-form">
            <fieldset class="pure-group">
                <input id="title" class="pure-input-1-2" placeholder="Title" required="true">
                <textarea id="description" class="pure-input-1-2" placeholder="Description"></textarea>
                <button type="submit" class="pure-button pure-button-primary">Add</button>
            </fieldset>
        </form>
        <div id="todos"></div>
    </div>
</body>

<!-- Todos rendering template -->
<script id="todo-template" type="text/x-handlebars-template">
    {{#each .}}
	<div class="todo">
		<div class="pure-button-group todo-action-group" role="group">
			<button class="pure-button" onclick='editTodo(this, {{{json .}}})'><i class="fas fa-edit"></i></button>
			<button class="pure-button" onclick="deleteTodo({{id}})"><i class="fas fa-trash-alt"></i></button>
		</div>
		<h3 onclick="toggleCompleted({{id}}, {{completed}})" {{#if completed}}class="todo-done"{{/if}}>{{title}}</h3>
		<div class="description" style="white-space: pre-line;">
	 		{{description}}   
	 	</div>
	</div>
	<hr/>
	{{/each}}
</script>

<!-- Todos rendering template (Edit mode) -->
<script id="todo-template-edit" type="text/x-handlebars-template">
	<form id="todoFormEdit" class="pure-form">
        <fieldset class="pure-group">
        	<input name="id" type="hidden" value="{{id}}">
            <input name="title" class="pure-input-1-2" placeholder="Title" value="{{title}}" required="true"></input>
            <textarea name="description" class="pure-input-1-2" placeholder="Description">{{description}}</textarea>
            <div class="pure-button-group" role="group">
                <button type="submit" class="pure-button-1-2 pure-button pure-button-primary">Edit</button>
                <button class="pure-button" onclick="updateView()">Cancel</button>
        	</div>
        </fieldset>
    </form>
</script>

<script type="text/javascript">

// Render json with handlebars
Handlebars.registerHelper('json', function(context) {
    return JSON.stringify(context);
});

// Pre-compile render templates
var todoTemplate = Handlebars.compile($("#todo-template").html());
var todoTemplateEdit = Handlebars.compile($("#todo-template-edit").html());

$(function() {

    // Handle form submit (Create a todo)
    $("#todoForm").submit(function(elem) {
        elem.preventDefault();
        $.ajax({
            type: "POST",
            url: "/api/todos",
            data: JSON.stringify({
                title: $("#title").val(),
                description: $("#description").val()
            }),
            complete: updateView
        })
        // Empty the form
        $("#title").val("")
        $("#description").val("")
    })

    // Handle edit form submit (Update a todo)
    $(".content").on("submit", "#todoFormEdit", function(elem) {
        elem.preventDefault();
        $.ajax({
            type: "PUT",
            url: "/api/todos/" + $(this).find('input[name="id"]').val(),
            data: JSON.stringify({
                title: $(this).find('input[name="title"]').val(),
                description: $(this).find('textarea[name="description"]').val()
            }),
            complete: updateView
        })
    })

    // Display todos
    updateView();
});


function updateView() {
    $.getJSON("/api/todos", function(todos) {
    	// Put completed todos at the end
        todos.sort(function(a, b) {
        	return a.completed
        })
        $("#todos").html(todoTemplate(todos));
    })
}

function deleteTodo(id) {
    $.ajax({
        type: "DELETE",
        url: "/api/todos/" + id,
        complete: updateView
    })
}

// Toggle the "completed" field of a todo
function toggleCompleted(id, value) {
    $.ajax({
        type: "PUT",
        url: "/api/todos/" + id,
        data: JSON.stringify({
            "completed": !value
        }),
        complete: updateView
    })
}

// Load the form for editing the todo
function editTodo(elem, todo) {
    $(elem).closest(".todo").html(todoTemplateEdit(todo));
}

</script>

</html>